name: PR Review & Checks

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write
  issues: write
  checks: write

jobs:
  # PR ì œëª© í˜•ì‹ ê²€ì¦ (Conventional Commits) - Optional
  pr-title-check:
    name: PR Title Check
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - name: Check PR Title Format
        uses: amannn/action-semantic-pull-request@v5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          types: |
            feat
            fix
            docs
            style
            refactor
            test
            chore
            perf
            ci
            build
            revert
          requireScope: false
          subjectPattern: ^.+$
          subjectPatternError: |
            ì œëª©ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤. ì„¤ëª…ì„ ì¶”ê°€í•´ì£¼ì„¸ìš”.
            ì˜ˆ: "feat: Add new feature" ë˜ëŠ” "feat: ìƒˆ ê¸°ëŠ¥ ì¶”ê°€"

  # ë°±ì—”ë“œ ì²´í¬ (Django/Python ê¸°ë°˜)
  backend-checks:
    name: Backend Checks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.13'

      - name: Install dependencies
        working-directory: ./backend
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run Django checks
        working-directory: ./backend
        id: django-check
        run: python manage.py check
        continue-on-error: true

      - name: Check Results
        if: steps.django-check.outcome == 'failure'
        run: |
          echo "Backend checks failed!"
          exit 1

  # í”„ë¡ íŠ¸ì—”ë“œ í…ŒìŠ¤íŠ¸ ë° ë¦°íŠ¸
  frontend-checks:
    name: Frontend Tests & Lint
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./frontend
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Run Lint
        id: lint
        run: npm run lint
        continue-on-error: true

      - name: Run Build
        id: build
        run: npm run build
        continue-on-error: true

      - name: Check Results
        if: steps.lint.outcome == 'failure' || steps.build.outcome == 'failure'
        run: |
          echo "Frontend checks failed!"
          exit 1

  # íŒŒì¼ ë³€ê²½ì‚¬í•­ ë¶„ì„ ë° PR ìš”ì•½
  pr-analysis:
    name: PR Analysis & Summary
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Analyze Changes
        id: analyze
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
            });

            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
            });

            // íŒŒì¼ ë¶„ë¥˜
            const backendFiles = files.filter(f => f.filename.startsWith('backend/'));
            const frontendFiles = files.filter(f => f.filename.startsWith('frontend/'));
            const docsFiles = files.filter(f => f.filename.startsWith('docs/'));
            const configFiles = files.filter(f =>
              f.filename.includes('.yml') ||
              f.filename.includes('.yaml') ||
              f.filename.includes('.json') ||
              f.filename.includes('Dockerfile')
            );
            const e2eFiles = files.filter(f => f.filename.startsWith('e2e/'));

            // í†µê³„ ê³„ì‚°
            const totalAdditions = files.reduce((sum, f) => sum + f.additions, 0);
            const totalDeletions = files.reduce((sum, f) => sum + f.deletions, 0);

            // ì½”ë©˜íŠ¸ ìƒì„±
            let comment = '## ğŸ“‹ PR ë¶„ì„ ë¦¬í¬íŠ¸\n\n';
            comment += `**ì œëª©**: ${pr.title}\n`;
            comment += `**ì‘ì„±ì**: @${pr.user.login}\n`;
            comment += `**ë³€ê²½ì‚¬í•­**: ${pr.changed_files}ê°œ íŒŒì¼ (+ ${totalAdditions} / - ${totalDeletions})\n\n`;

            // ë³€ê²½ íŒŒì¼ ì¹´í…Œê³ ë¦¬ë³„ í‘œì‹œ
            if (backendFiles.length > 0) {
              comment += '### ğŸ”§ ë°±ì—”ë“œ ë³€ê²½ì‚¬í•­\n';
              backendFiles.forEach(file => {
                const icon = file.status === 'added' ? 'âœ¨' : file.status === 'removed' ? 'ğŸ—‘ï¸' : 'ğŸ“';
                comment += `- ${icon} \`${file.filename}\` (+${file.additions}/-${file.deletions})\n`;
              });
              comment += '\n';
            }

            if (frontendFiles.length > 0) {
              comment += '### ğŸ¨ í”„ë¡ íŠ¸ì—”ë“œ ë³€ê²½ì‚¬í•­\n';
              frontendFiles.forEach(file => {
                const icon = file.status === 'added' ? 'âœ¨' : file.status === 'removed' ? 'ğŸ—‘ï¸' : 'ğŸ“';
                comment += `- ${icon} \`${file.filename}\` (+${file.additions}/-${file.deletions})\n`;
              });
              comment += '\n';
            }

            if (e2eFiles.length > 0) {
              comment += '### ğŸ§ª E2E í…ŒìŠ¤íŠ¸ ë³€ê²½ì‚¬í•­\n';
              e2eFiles.forEach(file => {
                const icon = file.status === 'added' ? 'âœ¨' : file.status === 'removed' ? 'ğŸ—‘ï¸' : 'ğŸ“';
                comment += `- ${icon} \`${file.filename}\` (+${file.additions}/-${file.deletions})\n`;
              });
              comment += '\n';
            }

            if (docsFiles.length > 0) {
              comment += '### ğŸ“š ë¬¸ì„œ ë³€ê²½ì‚¬í•­\n';
              docsFiles.forEach(file => {
                const icon = file.status === 'added' ? 'âœ¨' : file.status === 'removed' ? 'ğŸ—‘ï¸' : 'ğŸ“';
                comment += `- ${icon} \`${file.filename}\` (+${file.additions}/-${file.deletions})\n`;
              });
              comment += '\n';
            }

            if (configFiles.length > 0) {
              comment += '### âš™ï¸ ì„¤ì • íŒŒì¼ ë³€ê²½ì‚¬í•­\n';
              configFiles.forEach(file => {
                const icon = file.status === 'added' ? 'âœ¨' : file.status === 'removed' ? 'ğŸ—‘ï¸' : 'ğŸ“';
                comment += `- ${icon} \`${file.filename}\` (+${file.additions}/-${file.deletions})\n`;
              });
              comment += '\n';
            }

            // ì²´í¬ë¦¬ìŠ¤íŠ¸
            comment += '### âœ… ë³‘í•© ì „ ì²´í¬ë¦¬ìŠ¤íŠ¸\n';
            comment += '- [ ] ëª¨ë“  í…ŒìŠ¤íŠ¸ í†µê³¼\n';
            comment += '- [ ] ë¦°íŠ¸ í†µê³¼\n';
            comment += '- [ ] íƒ€ì… ì²´í¬ í†µê³¼\n';
            comment += '- [ ] ë¹Œë“œ ì„±ê³µ\n';
            comment += '- [ ] ì½”ë“œ ë¦¬ë·° ì™„ë£Œ\n';
            comment += '- [ ] ê´€ë ¨ ë¬¸ì„œ ì—…ë°ì´íŠ¸ë¨\n\n';

            // ê¶Œì¥ì‚¬í•­
            comment += '### ğŸ’¡ ê¶Œì¥ì‚¬í•­\n';

            if (backendFiles.length > 0 && e2eFiles.length === 0) {
              comment += '- âš ï¸ ë°±ì—”ë“œ ë³€ê²½ì‚¬í•­ì´ ìˆì§€ë§Œ E2E í…ŒìŠ¤íŠ¸ê°€ ì—…ë°ì´íŠ¸ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.\n';
            }

            if (frontendFiles.length > 0 && e2eFiles.length === 0) {
              comment += '- âš ï¸ í”„ë¡ íŠ¸ì—”ë“œ ë³€ê²½ì‚¬í•­ì´ ìˆì§€ë§Œ E2E í…ŒìŠ¤íŠ¸ê°€ ì—…ë°ì´íŠ¸ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.\n';
            }

            if (totalAdditions > 500) {
              comment += '- âš ï¸ í° ë³€ê²½ì‚¬í•­ì…ë‹ˆë‹¤. ì‘ì€ PRë¡œ ë‚˜ëˆ„ëŠ” ê²ƒì„ ê³ ë ¤í•´ë³´ì„¸ìš”.\n';
            }

            if (docsFiles.length === 0 && (backendFiles.length > 0 || frontendFiles.length > 0)) {
              comment += '- ğŸ“ ìƒˆë¡œìš´ ê¸°ëŠ¥ì´ë‚˜ ë³€ê²½ì‚¬í•­ì´ ìˆë‹¤ë©´ ë¬¸ì„œ ì—…ë°ì´íŠ¸ë¥¼ ê³ ë ¤í•´ë³´ì„¸ìš”.\n';
            }

            comment += '\n---\n';
            comment += '*ì´ ì½”ë©˜íŠ¸ëŠ” ìë™ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.*';

            // ê¸°ì¡´ ë´‡ ì½”ë©˜íŠ¸ ì°¾ê¸°
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(c =>
              c.user.type === 'Bot' &&
              c.body.includes('ğŸ“‹ PR ë¶„ì„ ë¦¬í¬íŠ¸')
            );

            if (botComment) {
              // ê¸°ì¡´ ì½”ë©˜íŠ¸ ì—…ë°ì´íŠ¸
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment,
              });
            } else {
              // ìƒˆ ì½”ë©˜íŠ¸ ìƒì„±
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment,
              });
            }

  # ì»¤ë°‹ ë©”ì‹œì§€ ê²€ì¦
  commit-message-check:
    name: Commit Message Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check Commit Messages
        uses: wagoid/commitlint-github-action@v6
        with:
          configFile: '.github/commitlint.config.js'
          failOnWarnings: false
        continue-on-error: true

  # í…ŒìŠ¤íŠ¸ ê²°ê³¼ ìš”ì•½
  test-summary:
    name: Test Results Summary
    runs-on: ubuntu-latest
    needs: [backend-checks, frontend-checks]
    if: always()
    steps:
      - name: Create Test Summary
        uses: actions/github-script@v7
        with:
          script: |
            const backendResult = '${{ needs.backend-checks.result }}';
            const frontendResult = '${{ needs.frontend-checks.result }}';

            let summary = '## ğŸ§ª í…ŒìŠ¤íŠ¸ ê²°ê³¼ ìš”ì•½\n\n';
            summary += '| ì˜ì—­ | ìƒíƒœ |\n';
            summary += '|------|------|\n';
            summary += `| ë°±ì—”ë“œ | ${backendResult === 'success' ? 'âœ… í†µê³¼' : 'âŒ ì‹¤íŒ¨'} |\n`;
            summary += `| í”„ë¡ íŠ¸ì—”ë“œ | ${frontendResult === 'success' ? 'âœ… í†µê³¼' : 'âŒ ì‹¤íŒ¨'} |\n`;

            if (backendResult !== 'success' || frontendResult !== 'success') {
              summary += '\n### âš ï¸ ì£¼ì˜ì‚¬í•­\n';
              summary += 'ì¼ë¶€ ì²´í¬ê°€ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ìì„¸í•œ ë‚´ìš©ì€ ìœ„ì˜ ì›Œí¬í”Œë¡œìš° ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.\n';
            } else {
              summary += '\n### âœ… ëª¨ë“  ì²´í¬ í†µê³¼\n';
              summary += 'ë¦¬ë·°ì–´ì˜ ìŠ¹ì¸ì„ ë°›ì€ í›„ ë³‘í•©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n';
            }

            // ê¸°ì¡´ ìš”ì•½ ì½”ë©˜íŠ¸ ì°¾ê¸°
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const summaryComment = comments.find(c =>
              c.user.type === 'Bot' &&
              c.body.includes('ğŸ§ª í…ŒìŠ¤íŠ¸ ê²°ê³¼ ìš”ì•½')
            );

            if (summaryComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: summaryComment.id,
                body: summary,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: summary,
              });
            }

  # ëª¨ë“  ì²´í¬ ì™„ë£Œ í™•ì¸
  all-checks-passed:
    name: All Checks Passed
    runs-on: ubuntu-latest
    needs: [backend-checks, frontend-checks]
    if: always()
    steps:
      - name: Check critical jobs status
        run: |
          if [ "${{ needs.backend-checks.result }}" == "failure" ] || [ "${{ needs.frontend-checks.result }}" == "failure" ]; then
            echo "Critical checks failed!"
            exit 1
          fi
          echo "All critical checks passed successfully!"
