# Use Case Specification: 엑셀 파일 업로드 (Atomic Transaction)

**문서 버전:** 1.0
**작성일:** 2025-12-18
**기능 ID:** UC-003
**우선순위:** High

---

## 1. 기능 개요

### 1.1 목적
이카운트(Ecount)에서 추출한 엑셀 데이터를 웹 시스템에 업로드하여 PostgreSQL 데이터베이스에 저장하고, 대시보드 시각화에 활용할 수 있도록 한다.

### 1.2 범위
- 엑셀 파일(.xlsx, .xls) 업로드 및 파싱
- 동일 기준일(reference_date) 데이터 자동 교체 (Atomic Transaction)
- 업로드 성공/실패 피드백

### 1.3 주요 사용자
- **관리자 (Administrator)**: 데이터 업로드 권한 보유 (is_staff=True)

---

## 2. 사전 조건 (Preconditions)

### 2.1 시스템 요구사항
- 사용자가 로그인 완료 상태 (Django Session 인증)
- 사용자가 관리자 권한 보유 (is_staff=True)
- PostgreSQL 데이터베이스 연결 정상

### 2.2 데이터 요구사항
- 엑셀 파일이 다음 필수 컬럼을 포함:
  - `reference_date` (날짜)
  - `department` (부서)
  - `category` (카테고리)
  - `value` (실적)

---

## 3. 입력 (Input)

### 3.1 페이지
- **URL:** `/upload`
- **접근 권한:** 로그인 필요 + 관리자 권한

### 3.2 사용자 인터랙션
1. 파일 선택 버튼 클릭 또는 Drag & Drop 영역에 파일 드래그
2. 파일 선택 후 "업로드" 버튼 클릭

### 3.3 파일 제약사항
| 항목 | 제약 |
|------|------|
| **파일 형식** | `.xlsx`, `.xls` |
| **최대 크기** | 10MB |
| **최대 행 수** | 제한 없음 (권장: 50,000행 이하) |

---

## 4. 처리 흐름 (Process Flow)

### 4.1 프론트엔드 검증
1. 파일 확장자 검증 (`.xlsx`, `.xls`)
2. 파일 크기 검증 (10MB 이하)
3. 검증 실패 시 에러 메시지 표시 후 프로세스 중단

### 4.2 API 요청
- **Method:** POST
- **Endpoint:** `/api/upload/`
- **Content-Type:** `multipart/form-data`
- **Authentication:** Session Cookie
- **Request Body:**
  ```
  file: <Excel File Binary>
  ```

### 4.3 백엔드 처리

#### 단계 1: 파일 수신 및 검증
- Django View에서 업로드된 파일 수신
- 파일 존재 여부 확인
- 파일 형식 재검증 (확장자, MIME 타입)

#### 단계 2: 엑셀 파싱
- Pandas `read_excel()` 함수로 파일 파싱
- 필수 컬럼 존재 여부 검증:
  - `reference_date`
  - `department`
  - `category`
  - `value`
- 컬럼 누락 시 에러 반환

#### 단계 3: 데이터 추출
- 첫 번째 행의 `reference_date` 값 추출
- 전체 행의 데이터 타입 변환:
  - `reference_date` → Python `date` 객체
  - `value` → `Decimal` 타입 (금액 정밀도 보장)
  - `department`, `category` → 문자열 (공백 제거)

#### 단계 4: Atomic Transaction 실행
```
BEGIN TRANSACTION

1. DELETE FROM performance_data
   WHERE reference_date = extracted_date;

2. BULK INSERT INTO performance_data
   (reference_date, department, category, value)
   VALUES (...), (...), ...
   BATCH_SIZE = 1000;

COMMIT TRANSACTION
```

**중요 특성:**
- 전체 성공 또는 전체 롤백 (All or Nothing)
- 동일 reference_date의 기존 데이터 완전 삭제 후 신규 삽입
- 부분 삽입 불가능 (데이터 일관성 보장)

#### 단계 5: 응답 생성
- **성공 시:**
  ```json
  {
    "message": "업로드 완료",
    "count": 150,
    "reference_date": "2024-01-01"
  }
  ```
- **실패 시:**
  ```json
  {
    "error": "구체적인 에러 메시지"
  }
  ```

---

## 5. 출력 (Output)

### 5.1 성공 시 UI 표시
1. 초록색 체크 아이콘 표시
2. 성공 메시지: "업로드 완료! N개의 데이터가 저장되었습니다."
3. 3초 후 자동으로 대시보드 페이지(`/dashboard`)로 리다이렉트
4. 대시보드에서 새 데이터 자동 반영

### 5.2 실패 시 UI 표시
- 빨간색 경고 아이콘 표시
- 에러 메시지 표시:
  - "지원하지 않는 파일 형식입니다. .xlsx 또는 .xls 파일을 업로드하세요."
  - "파일 크기가 10MB를 초과합니다."
  - "엑셀 파일의 데이터 형식이 올바르지 않습니다. 필수 컬럼을 확인하세요."
  - "필수 컬럼이 누락되었습니다: [컬럼명]"
  - "서버 오류가 발생했습니다. 관리자에게 문의하세요."

---

## 6. 연관 시스템 및 리소스

### 6.1 API 엔드포인트
| Endpoint | Method | 역할 |
|----------|--------|------|
| `/api/upload/` | POST | 엑셀 파일 업로드 및 저장 |

### 6.2 데이터베이스 테이블
| 테이블명 | 역할 |
|----------|------|
| `performance_data` | 업로드된 실적 데이터 저장 |

**스키마:**
- `id` (SERIAL PRIMARY KEY)
- `reference_date` (DATE NOT NULL, INDEX)
- `department` (VARCHAR(100) NOT NULL, INDEX)
- `category` (VARCHAR(100) NOT NULL)
- `value` (DECIMAL(15,2) NOT NULL)
- `created_at` (TIMESTAMP)

### 6.3 외부 연동 서비스
- **없음** (모든 처리가 내부 시스템에서 완결)

### 6.4 관련 페이지
| 페이지 | URL | 연관성 |
|--------|-----|--------|
| 데이터 업로드 페이지 | `/upload` | 기능 실행 페이지 |
| 대시보드 페이지 | `/dashboard` | 업로드 후 리다이렉트 대상 |

---

## 7. 비즈니스 규칙

### 7.1 데이터 덮어쓰기 규칙
- 동일한 `reference_date`의 데이터가 이미 존재할 경우, 기존 데이터를 완전히 삭제하고 새 데이터로 교체
- 예시: 2024-01-01 데이터를 재업로드하면 기존 2024-01-01 데이터는 모두 삭제됨

### 7.2 Transaction 무결성
- Atomic Transaction으로 DELETE와 INSERT가 하나의 단위로 처리
- 중간에 에러 발생 시 모든 변경사항 자동 롤백
- 데이터베이스 일관성 보장

### 7.3 동시 업로드 방지
- 업로드 진행 중 "업로드" 버튼 비활성화
- 동일 사용자의 중복 요청 방지

---

## 8. 예외 처리 (Exception Handling)

### 8.1 클라이언트 측 에러

| 에러 상황 | 에러 메시지 | 대응 |
|-----------|-------------|------|
| 파일 형식 오류 | "지원하지 않는 파일 형식입니다. .xlsx 또는 .xls 파일을 업로드하세요." | 올바른 파일 선택 안내 |
| 파일 크기 초과 | "파일 크기가 10MB를 초과합니다." | 데이터 분할 또는 압축 안내 |
| 파일 미선택 | "파일을 선택해주세요." | 파일 선택 요구 |

### 8.2 서버 측 에러

| 에러 상황 | HTTP 코드 | 에러 메시지 | 대응 |
|-----------|-----------|-------------|------|
| 파싱 실패 | 400 | "엑셀 파일의 데이터 형식이 올바르지 않습니다." | 엑셀 템플릿 확인 안내 |
| 필수 컬럼 누락 | 400 | "필수 컬럼이 누락되었습니다: [컬럼명]" | 컬럼 추가 안내 |
| 빈 파일 | 400 | "엑셀 파일에 데이터가 없습니다." | 데이터 입력 후 재업로드 |
| DB 저장 실패 | 500 | "서버 오류가 발생했습니다. 관리자에게 문의하세요." | 관리자 연락 |
| 권한 없음 | 403 | "데이터 업로드 권한이 없습니다." | 관리자 권한 요청 |

### 8.3 네트워크 에러

| 에러 상황 | 에러 메시지 | 대응 |
|-----------|-------------|------|
| 타임아웃 (30초 초과) | "업로드 시간이 초과되었습니다. 다시 시도해주세요." | 재시도 버튼 제공 |
| 연결 끊김 | "인터넷 연결을 확인하세요." | 네트워크 확인 안내 |

---

## 9. 엣지 케이스 (Edge Cases)

### 9.1 빈 엑셀 파일
- **상황:** 엑셀 파일에 헤더만 있고 데이터 행이 없음
- **처리:** HTTP 400 + "엑셀 파일에 데이터가 없습니다." 메시지
- **결과:** 업로드 실패

### 9.2 중복 reference_date
- **상황:** 이미 DB에 2024-01-01 데이터가 존재하는데, 동일한 날짜의 파일 재업로드
- **처리:** 기존 데이터 DELETE 후 신규 데이터 INSERT
- **결과:** 최신 업로드 데이터로 교체 (의도된 동작)

### 9.3 Transaction 롤백
- **상황:** 1000개 중 500개 삽입 후 DB 오류 발생
- **처리:** Atomic Transaction 롤백 → 모든 변경사항 취소
- **결과:** 기존 데이터 유지 (부분 삽입 없음)

### 9.4 대용량 파일
- **상황:** 50,000행 이상의 대용량 엑셀 파일
- **처리:** bulk_create의 batch_size=1000으로 청크 단위 처리
- **결과:** 메모리 효율적으로 처리 (성능 약간 저하 가능)

### 9.5 잘못된 데이터 타입
- **상황:** value 컬럼에 숫자가 아닌 텍스트 입력
- **처리:** 타입 변환 실패 → HTTP 400 에러
- **결과:** "데이터 형식이 올바르지 않습니다. value는 숫자여야 합니다."

### 9.6 동시 업로드 시도
- **상황:** 두 명의 관리자가 동시에 다른 날짜의 파일 업로드
- **처리:** 각 Transaction이 독립적으로 실행 (reference_date 단위로 격리)
- **결과:** 두 업로드 모두 성공 (서로 다른 날짜이므로 충돌 없음)

### 9.7 네트워크 타임아웃
- **상황:** 업로드 중 네트워크 끊김 (30초 초과)
- **처리:** 프론트엔드에서 타임아웃 에러 표시
- **결과:** 업로드 실패, Transaction 롤백 (DB에 영향 없음)

---

## 10. 성능 요구사항

### 10.1 응답 시간
| 데이터 크기 | 목표 시간 |
|-------------|-----------|
| 1,000행 | 2초 이내 |
| 10,000행 | 5초 이내 |
| 50,000행 | 15초 이내 |

### 10.2 처리량
- 동시 업로드 지원: 최대 5명 (관리자 수 제한)
- 일일 업로드 횟수: 제한 없음

---

## 11. 보안 요구사항

### 11.1 인증 및 권한
- Django Session 기반 인증 필수
- `is_staff=True` 권한 필요 (관리자만 업로드 가능)

### 11.2 파일 검증
- 확장자 화이트리스트 검증 (`.xlsx`, `.xls`)
- MIME 타입 검증
- 파일 크기 제한 (10MB)

### 11.3 SQL Injection 방지
- Django ORM 사용 (파라미터 바인딩 자동)
- Raw SQL 금지

### 11.4 CSRF 보호
- Django CSRF 토큰 검증 (기본 활성화)

---

## 12. 테스트 시나리오

### 12.1 정상 시나리오
1. 관리자 로그인
2. 데이터 업로드 페이지 접근
3. 올바른 형식의 엑셀 파일 선택
4. 업로드 버튼 클릭
5. "업로드 완료" 메시지 확인
6. 대시보드로 자동 이동
7. 차트에 새 데이터 반영 확인

### 12.2 에러 시나리오
1. 잘못된 파일 형식 (.csv) 업로드 → 에러 메시지 표시
2. 10MB 초과 파일 업로드 → 에러 메시지 표시
3. 필수 컬럼 누락 엑셀 업로드 → 400 에러 + 구체적 메시지
4. 빈 엑셀 파일 업로드 → 400 에러 + "데이터 없음" 메시지

### 12.3 중복 업로드 시나리오
1. 2024-01-01 데이터 100개 업로드 (성공)
2. 동일 날짜 데이터 150개 재업로드 (성공)
3. DB 조회 결과: 2024-01-01 데이터 150개만 존재 (100개 삭제됨)

---

## 13. 후속 작업 연결

### 13.1 업로드 후 자동 실행
- 대시보드 페이지로 리다이렉트 (3초 후)
- 대시보드에서 `/api/data/` 재조회 → 차트 갱신

### 13.2 관련 유스케이스
- **UC-002: 대시보드 조회** - 업로드된 데이터를 시각화
- **UC-004: 데이터 테이블 조회** - 업로드된 원본 데이터 확인

---

## 14. 제약사항 및 가정

### 14.1 제약사항
- 엑셀 파일만 지원 (CSV, JSON 등 미지원)
- 최대 파일 크기 10MB
- 업로드 권한은 관리자만 보유

### 14.2 가정
- 엑셀 파일은 이카운트에서 추출한 표준 형식
- 모든 행의 reference_date는 동일 (첫 행 기준)
- 네트워크 환경은 안정적 (타임아웃 30초 이내)

---

## 15. 문서 변경 이력

| 버전 | 날짜 | 변경 내용 | 작성자 |
|------|------|-----------|--------|
| 1.0 | 2025-12-18 | 초안 작성 | Usecase Writer Agent |

---

**End of Document**
