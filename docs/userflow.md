# User Flow Document
# 대학 데이터 시각화 대시보드

**문서 버전:** 1.0
**작성일:** 2025-12-18
**프로젝트명:** 대학 데이터 시각화 대시보드
**기술 스택:** Django + React + Supabase PostgreSQL

---

## 1. 로그인 (Django Native Auth)

### 1.1 입력
- 사용자가 로그인 페이지 접근
- 아이디 입력 필드에 Username 입력
- 비밀번호 입력 필드에 Password 입력
- 로그인 버튼 클릭

### 1.2 처리
1. **요청 수신**
   - 프론트엔드에서 `/admin/login/` 엔드포인트로 POST 요청 전송
   - CSRF 토큰 검증

2. **인증 검증**
   - Django Authentication Backend에서 사용자 자격 증명 확인
   - 데이터베이스에서 Username 조회
   - PBKDF2 해싱 알고리즘으로 비밀번호 검증

3. **세션 생성 (성공 시)**
   - 세션 ID 생성
   - 세션 쿠키 설정 (HttpOnly, Secure 플래그)
   - 사용자 정보를 세션에 저장

4. **로그 기록**
   - 로그인 시도 기록 (성공/실패)
   - 타임스탬프 저장

### 1.3 출력
**성공 시:**
- HTTP 302 리다이렉트 응답
- 대시보드 페이지(`/dashboard`)로 이동
- 세션 쿠키 브라우저에 저장

**실패 시:**
- HTTP 401 Unauthorized 응답
- 로그인 페이지에 에러 메시지 표시
- 입력 필드 초기화하지 않음 (아이디는 유지, 비밀번호만 초기화)

**엣지케이스:**
- 계정 잠금: 5회 이상 연속 실패 시 15분간 로그인 차단
- 네트워크 오류: 타임아웃 에러 메시지 표시
- CSRF 토큰 만료: 페이지 새로고침 후 재시도 안내

---

## 2. 대시보드 조회 (3종 차트)

### 2.1 입력
- 사용자가 로그인 완료 후 대시보드 페이지 접근
- (선택) 기간 필터 선택 (DatePicker)
- (선택) 부서 필터 선택 (Multi-select Dropdown)
- (선택) 카테고리 필터 선택 (Checkbox Group)
- 차트 위 호버 인터랙션
- (선택) 파이 차트 섹션 클릭

### 2.2 처리
1. **페이지 로드 시**
   - `/api/data/` 엔드포인트로 GET 요청 전송
   - 세션 쿠키 기반 인증 확인
   - 인증 실패 시 `/admin/login/` 리다이렉트

2. **데이터 조회**
   - Django ORM으로 PerformanceData 모델 쿼리
   - 필터 파라미터가 있으면 WHERE 절 적용
   - `reference_date`, `department` 인덱스 활용
   - 결과를 JSON으로 직렬화 (DRF Serializer)

3. **데이터 가공 (프론트엔드)**
   - 월별 추이: `reference_date` 기준 GROUP BY 후 SUM 계산
   - 부서별 실적: `department` 기준 GROUP BY 후 SUM 계산
   - 카테고리별 분포: `category` 기준 COUNT 및 백분율 계산

4. **차트 렌더링**
   - Recharts 라이브러리로 3종 차트 생성
   - 반응형 레이아웃 적용 (Grid System)
   - 색상 팔레트 자동 할당

5. **필터 적용 시**
   - 상태 업데이트 (React useState)
   - 쿼리 파라미터 재구성
   - API 재요청 (`/api/data/?start_date=...&department=...`)
   - 차트 리렌더링

### 2.3 출력
**성공 시:**
- 3종 차트 화면에 표시
  - 월별 추이 라인 차트 (X축: 월, Y축: 실적 값)
  - 부서별 실적 막대그래프 (X축: 부서명, Y축: 실적 값)
  - 카테고리별 분포 파이 차트 (퍼센트 + 절대값)
- 호버 시 툴팁으로 상세 수치 표시
- 로딩 완료 시간: 3초 이내
- 필터 적용 시 1초 이내 리렌더링

**엣지케이스:**
- 데이터 없음: 빈 상태 메시지 표시 ("데이터가 없습니다. 엑셀을 업로드하세요.")
- 네트워크 오류: 에러 배너 표시 및 재시도 버튼 제공
- 세션 만료: 자동으로 로그인 페이지로 리다이렉트
- 대용량 데이터: 페이지네이션 또는 무한 스크롤 적용
- 필터 결과 없음: "조건에 맞는 데이터가 없습니다." 메시지 표시

---

## 3. 엑셀 파일 업로드 (Atomic Transaction)

### 3.1 입력
- 사용자가 데이터 업로드 페이지 접근 (`/upload`)
- 파일 선택 버튼 클릭 또는 Drag & Drop으로 엑셀 파일 선택
- 지원 포맷: `.xlsx`, `.xls`
- 최대 파일 크기: 10MB
- 업로드 버튼 클릭

### 3.2 처리
1. **파일 검증 (프론트엔드)**
   - 파일 확장자 체크 (`.xlsx`, `.xls`)
   - 파일 크기 체크 (10MB 이하)
   - 검증 실패 시 에러 메시지 표시 후 중단

2. **파일 전송**
   - `multipart/form-data` 형식으로 POST 요청 생성
   - `/api/upload/` 엔드포인트로 전송
   - 세션 쿠키 기반 인증 확인

3. **서버 측 파싱**
   - Django View에서 파일 수신
   - Pandas `read_excel()` 함수로 파싱
   - 필수 컬럼 존재 여부 검증:
     - `reference_date` (날짜)
     - `department` (부서)
     - `category` (카테고리)
     - `value` (실적)

4. **데이터 추출**
   - 첫 번째 행의 `reference_date` 값을 추출
   - 데이터 타입 변환:
     - `reference_date` → Python `date` 객체
     - `value` → `Decimal` 타입

5. **Atomic Transaction 실행**
   ```python
   with transaction.atomic():
       # 1단계: 동일한 reference_date의 기존 데이터 삭제
       PerformanceData.objects.filter(
           reference_date=extracted_date
       ).delete()

       # 2단계: 새 데이터 일괄 삽입 (bulk_create)
       PerformanceData.objects.bulk_create([
           PerformanceData(
               reference_date=row['reference_date'],
               department=row['department'],
               category=row['category'],
               value=row['value']
           )
           for row in df.itertuples()
       ])
   ```

6. **응답 생성**
   - 성공 시: `{ "message": "업로드 완료", "count": 150 }`
   - 실패 시: `{ "error": "구체적인 에러 메시지" }` + HTTP 400

### 3.3 출력
**성공 시:**
- 초록색 체크 아이콘 표시
- 성공 메시지 표시 (업로드된 행 수 포함)
- 3초 후 자동으로 대시보드 페이지로 리다이렉트
- 대시보드에서 새 데이터 자동 반영

**실패 시 (클라이언트):**
- 파일 형식 오류: "지원하지 않는 파일 형식입니다. .xlsx 또는 .xls 파일을 업로드하세요."
- 파일 크기 초과: "파일 크기가 10MB를 초과합니다."

**실패 시 (서버):**
- 파싱 실패: "엑셀 파일의 데이터 형식이 올바르지 않습니다. 필수 컬럼을 확인하세요."
- 필수 컬럼 누락: "필수 컬럼이 누락되었습니다: [컬럼명]"
- DB 저장 실패: "서버 오류가 발생했습니다. 관리자에게 문의하세요."

**엣지케이스:**
- 빈 파일: "엑셀 파일에 데이터가 없습니다."
- 중복 업로드: 기존 데이터 삭제 후 새 데이터로 교체 (Atomic)
- Transaction 롤백: 중간 에러 발생 시 모든 변경 사항 취소
- 네트워크 타임아웃: 30초 제한 후 에러 메시지 표시
- 동시 업로드 방지: 업로드 중 버튼 비활성화

---

## 4. 데이터 테이블 조회 (MUI DataGrid)

### 4.1 입력
- 사용자가 데이터 테이블 페이지 접근 (`/data-table`)
- (선택) 검색 바에 텍스트 입력
- (선택) 컬럼 헤더 클릭으로 정렬
- (선택) 페이지네이션 버튼 클릭
- (선택) CSV 내보내기 버튼 클릭

### 4.2 처리
1. **데이터 조회**
   - `/api/data/` 엔드포인트로 GET 요청 전송
   - 세션 인증 확인
   - Django ORM으로 전체 데이터 조회 (또는 페이지별 조회)

2. **MUI DataGrid 초기화**
   - 컬럼 정의:
     - `reference_date` (날짜, 정렬 가능)
     - `department` (부서, 정렬 가능)
     - `category` (카테고리, 정렬 가능)
     - `value` (실적, 정렬 가능)
   - 페이지네이션 설정 (한 페이지당 50개 행)

3. **검색 처리**
   - 클라이언트 측 필터링:
     - 모든 컬럼 대상 텍스트 매칭
     - 대소문자 구분 안 함
   - 결과를 DataGrid에 반영

4. **정렬 처리**
   - 컬럼 헤더 클릭 시 오름차순/내림차순 토글
   - 정렬 상태를 React State에 저장

5. **CSV 내보내기**
   - 현재 필터/정렬 상태의 데이터를 CSV 형식으로 변환
   - Blob 객체 생성 후 다운로드 트리거
   - 파일명: `data_export_YYYYMMDD.csv`

### 4.3 출력
**성공 시:**
- 테이블 형태로 데이터 표시
- 각 컬럼 정렬 가능 (화살표 아이콘 표시)
- 검색 결과 실시간 업데이트
- 페이지네이션 컨트롤 표시 (이전/다음, 페이지 번호)
- CSV 다운로드 완료 시 브라우저 다운로드 폴더에 저장

**엣지케이스:**
- 데이터 없음: "조회된 데이터가 없습니다." 메시지 표시
- 검색 결과 없음: "검색 결과가 없습니다." 메시지 표시
- 대용량 데이터: 가상 스크롤링 적용 (DataGrid 기본 기능)
- 네트워크 오류: 에러 배너 표시 및 재시도 버튼
- CSV 내보내기 실패: 에러 메시지 표시

---

## 5. 로그아웃

### 5.1 입력
- 사용자가 사이드바 또는 헤더의 로그아웃 버튼 클릭

### 5.2 처리
1. **로그아웃 요청**
   - `/admin/logout/` 엔드포인트로 POST 요청 전송
   - CSRF 토큰 포함

2. **세션 종료**
   - Django에서 세션 데이터 삭제
   - 세션 쿠키 무효화 (만료 시간 과거로 설정)

3. **클라이언트 측 정리**
   - React 전역 상태 초기화 (사용자 정보 삭제)
   - 로컬 스토리지/세션 스토리지 클리어

### 5.3 출력
**성공 시:**
- HTTP 302 리다이렉트 응답
- 로그인 페이지(`/admin/login/`)로 이동
- 로그아웃 확인 메시지 표시 (선택 사항)

**엣지케이스:**
- 네트워크 오류: 클라이언트 측에서 강제 리다이렉트
- 이미 세션 만료: 로그인 페이지로 리다이렉트
- 뒤로가기 방지: 로그아웃 후 보호된 페이지 접근 시 재인증 요구

---

## 부록: 엣지케이스 종합 정리

### A1. 인증 관련
- **세션 만료**: 모든 API 요청에서 401 응답 시 자동 로그인 페이지 리다이렉트
- **동시 로그인**: 동일 계정 여러 브라우저 허용 (세션 관리)
- **비밀번호 변경**: Django Admin에서 변경 후 모든 세션 무효화

### A2. 데이터 관련
- **동시 업로드**: 파일 업로드 시 Lock 메커니즘 (Database Row Lock)
- **중복 날짜**: 동일 `reference_date` 업로드 시 기존 데이터 덮어쓰기
- **부분 실패**: Atomic Transaction으로 롤백 보장

### A3. 성능 관련
- **대용량 데이터**: 10,000행 이상 시 페이지네이션 필수
- **차트 렌더링**: 데이터 포인트 1,000개 이상 시 샘플링 적용
- **메모리 부족**: 서버 측 스트리밍 처리 (향후 개선)

### A4. UI/UX 관련
- **로딩 상태**: 모든 비동기 작업에 로딩 스피너 표시
- **에러 복구**: 재시도 버튼 또는 자동 재시도 (최대 3회)
- **오프라인**: 네트워크 끊김 시 "인터넷 연결을 확인하세요." 메시지

---

**문서 변경 이력**

| 버전 | 날짜 | 변경 내용 | 작성자 |
|------|------|-----------|--------|
| 1.0 | 2025-12-18 | 초안 작성 | Userflow Writer Agent |
